<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
        * {
            padding: 0;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }
        body {
            width: 100%;
            min-height: 100vh;
            overflow-x: hidden;
            background-color: white;
            font-family: "Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            display: flex;
            flex-direction: column;
            padding-top: 70px; /* Space for fixed header */
        }
        h1, h2, h3, h4, h5, h6,
        .h1, .h2, .h3, .h4, .h5, .h6 {
            font-family: "Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        a {
            transition: .3s all ease;
        }
        a, a:hover {
            text-decoration: none !important;
        }

        /* ===== Navigation Styles ===== */
        nav {
            width: 100%;
            height: 70px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo img {
            width: 150px;
        }

        .nav-links {
            display: flex;
            align-items: center;
        }

        .nav-links a {
            color: black;
            text-decoration: none;
            cursor: pointer;
            position: relative;
            margin: 0 20px;
            transition: 0.3s linear;
            font-weight: 600;
        }

        .nav-links a::before {
            content: "";
            position: absolute;
            left: 0;
            bottom: -4px;
            width: 0;
            background-color: #f74f10;
            height: 3.5px;
            transition: 0.3s linear;
        }

        .nav-links a:hover::before,
        .nav-links a:hover {
            color: #f74f10;
            width: 100%;
        }

        .wishlist-link i {
            font-size: 1.2rem;
            color: #333;
            transition: all 0.3s ease;
            margin-left: 20px;
        }
        
        .cart-link i {
            font-size: 1.2rem;
            color: #333;
            transition: all 0.3s ease;
            margin-left: 20px;
        }
        
        .wishlist-link i:hover,
        .cart-link i:hover {
            color: #f74f10;
            transform: scale(1.1);
        }
        
        .logout-link {
            padding: 8px 18px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-weight: 600;
            margin-left: 20px;
        }

        .mobile-menu-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
            color: #333;
        }

        /* Checkout Main Content */
        .checkout-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .checkout-heading {
            text-align: center;
            margin: 30px 0;
            color: #333;
            font-weight: 600;
            text-decoration: underline;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        /* Billing Details */
        .checkout-section {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .checkout-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .personal-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #f74f10;
        }

        .user-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-address {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .shipping-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shipping-option input[type="radio"] {
            accent-color: #f74f10;
        }

        .btn {
            display: inline-block;
            background: #f74f10;
            color: white;
            padding: 10px 20px;
            margin: 10px 0;
            border-radius: 5px;
            text-decoration: none;
            transition: background 0.3s;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: #8a3313;
            color: white;
        }

        /* Order Details */
        .table-details {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .table-details th, 
        .table-details td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table-details th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .table-details tfoot tr {
            font-weight: 600;
            background-color: #f8f9fa;
        }

        .tax {
            color: #666;
        }

        .order-table {
            font-size: 1.1rem;
        }

        /* Coupon Section */
        .coupon-section {
            grid-column: 1 / -1;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .coupon-label {
            display: block;
            margin-bottom: 10px;
            color: #666;
        }

        .coupon-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .coupon-inputbox {
            display: flex;
            gap: 10px;
            flex: 1;
            min-width: 300px;
        }

        .form-control {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #f74f10;
            box-shadow: 0 0 0 2px rgba(247, 79, 16, 0.2);
        }

        .coupon-values {
            flex: 1;
            min-width: 300px;
        }

        .coupon-discount, 
        .coupon-price {
            margin: 5px 0;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #2ecc71;
            margin-left: 10px;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        /* Payment Section */
        .payment-section {
            grid-column: 1 / -1;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .payment-method {
            margin-bottom: 20px;
        }

        .payment-method label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            background-color: #fff;
            transition: all 0.3s;
        }

        .form-select:focus {
            outline: none;
            border-color: #f74f10;
            box-shadow: 0 0 0 2px rgba(247, 79, 16, 0.2);
        }

        .placeorder {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        /* Footer */
        .simple-footer {
            background-color: #141d2a;
            color: white;
            padding: 4rem 0;
            margin-top: 50px;
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .footer-section {
            flex: 1;
            min-width: 200px;
            margin-bottom: 30px;
            padding: 0 15px;
        }
        
        .footer-section h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: white;
            position: relative;
            padding-bottom: 10px;
        }
        
        .footer-section h3::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: 0;
            width: 40px;
            height: 2px;
            background-color: #f74f10;
        }
        
        .footer-section ul {
            list-style: none;
            padding: 0;
        }
        
        .footer-section ul li {
            margin-bottom: 10px;
        }
        
        .footer-section ul li a {
            color: #aaa;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-section ul li a:hover {
            color: white;
        }
        
        .footer-cta {
            width: 100%;
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 1px solid #333;
        }
        
        .footer-cta h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: white;
        }
        
        .footer-cta p {
            font-size: 16px;
            margin-bottom: 20px;
            color: #aaa;
            font-weight: bold;
        }
        
        .footer-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .footer-actions .btn {
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .footer-actions .btn-outline {
            background: transparent;
            border: 1px solid #f74f10;
            color: #f74f10;
        }
        
        .footer-actions .btn-outline:hover {
            background: #f74f10;
            color: white;
        }
        
        .weather-widget {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
        }
        
        .weather-widget .temp {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .weather-widget .condition {
            font-size: 14px;
            color: #aaa;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }
            
            .footer-section {
                min-width: calc(50% - 30px);
            }
        }

        @media (max-width: 768px) {
            /* Mobile menu styles */
            .nav-links {
                position: fixed;
                top: 70px;
                left: -100%;
                width: 100%;
                background: white;
                flex-direction: column;
                padding: 20px;
                gap: 15px;
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
                transition: 0.3s ease;
            }
            
            .nav-links.active {
                left: 0;
            }
            
            .nav-links a {
                margin: 10px 0;
                padding: 8px 0;
                font-size: 1.1rem;
            }
            
            .wishlist-link i,
            .cart-link i {
                margin-left: 0;
                margin-right: 10px;
            }
            
            .logout-link {
                margin-left: 0;
                display: inline-block;
                width: 100%;
                text-align: left;
                padding: 8px 0;
            }
            
            .mobile-menu-toggle {
                display: block;
            }

            .coupon-content {
                flex-direction: column;
            }
            
            .coupon-inputbox {
                min-width: 100%;
            }
            
            .placeorder {
                flex-direction: column;
            }
        }

        @media (max-width: 576px) {
            .footer-section {
                min-width: 100%;
                text-align: center;
            }
            
            .footer-section h3::after {
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>

    <nav>
        <div class="nav-container">
            <div class="logo">
                <a href="/"><img src="/images/logo.png" alt="Logo"></a>
            </div>
            <div class="nav-links">
                <a href="/Homepage">HOME</a>
                <a href="/allproduct">PRODUCTS</a>
                <a href="">ABOUT</a>
                <a href="">CONTACT</a>
                <a href="/userProfile">ACCOUNT</a>
                <a href="/logout" id="logout-button" class="logout-link">LOGOUT</a>
                <a href="/wishlist" class="wishlist-link">
                    <i class="fas fa-heart"></i>
                </a>
                <a href="/cart" class="cart-link">
                    <i class="fa fa-shopping-cart"></i>
                </a>
            </div>
            <button class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <div class="checkout-container">
        <h1 class="checkout-heading">Checkout</h1>
      
            <form action="/checkoutPost" method="POST">
             <div class="checkout-grid">
               <div class="checkout-section">
                 <h2 class="section-title">Billing details</h2>
                <div class="personal-info">
                    <i class="fas fa-user"></i>Personal Information
                </div>
                <% if(address && Array.isArray(address) && address.length > 0) { %>
                    <div class="payment-shipping">
                        <% address.forEach((product, index) => { %>
                            <div class="user-details">
                                <div class="user-name">
                                    <%= product.firstname %>
                                    <%= product.lastname %>
                                </div>
                                <div class="user-address">ShippingAddress:<%= product.address %>,
                                    <%= product.city %>,
                                    <%= product.pincode %>,
                                    <%= product.number %>
                                </div>
                                <div class="shipping-option">
                                    <input type="radio" id="shippingOption<%= product._id %>" name="shippingOption" value="<%= product._id %>" <%= index === 0 ? 'checked' : '' %>>
                                    <label for="shippingOption<%= product._id %>">Select this shipping option</label>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <p>No Shipping information available.</p>
                <% } %>

            

                <div class="add-addressbtn">
                    <a href="/orderAddress" class="btn">Add Address</a>
                    <div id="addressError" style="color:red; margin-top:10px;"></div>
                </div>
            </div>

            <div class="checkout-section">
                <h2 class="section-title">Your Order</h2>
                <table class="table-details">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% checkout.forEach((product, index) => { %>
                        <tr>
                            <td><%= product.productname %> x <%= product.quantity %></td>
                            <td>₹<%= product.price * product.quantity %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                    <tr>
                        <td class="tax">Tax:</td>
                        <td>₹<%= totaltax.toFixed(2) %></td>
                    </tr>
                    <tfoot>
                        <tr>
                            <td class="order-table">Order Total:</td>
                            <td>₹<%= totalsum %></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="coupon-section">
                <h2 class="section-title">Coupon Code</h2>
                <label for="coupencode" class="coupon-label">Enter your code if you have one</label>
                <div class="coupon-content">
                    <div class="coupon-inputbox">
                        <input type="text" id="coupencode" class="form-control" name="coupencode" placeholder="Enter the code">
                        <button id="applycoupen" type="button" class="btn">Apply Now</button>
                    </div>
                    <div class="coupon-values">
                        <h5 class="coupon-discount">Discount:₹ <span id="discountvalue">0.00</span></h5>
                        <h5 class="coupon-price">Price: <span id="total-price2"><%= totalsum %></span></h5>
                    </div>
                </div>
                <button id="deletecouponbtn" type="button" class="btn btn-danger" onclick="deleteCoupon()">Remove Coupon</button>
                <a href="/allCoupens" id="available-coupen">
                    <button class="btn btn-success" type="button">Available Coupons</button>
                    <div id="messageContainer" class="coupon-message" style="color: red;"></div>
                </a>
            </div>
            <span id="price" data-totalPrice="<%= totalsum %>"></span>

            <div class="payment-section">
                <h2 class="section-title">Payment Method</h2>
                <div class="payment-method"> 
                    <label for="paymentmethod">Payment Method:</label>
                    <select class="form-select" id="paymentmethod" name="paymentMethod" >
                        <option value="" disabled selected>Choose a Payment</option>
                        <option value="Cash on Delivery">Cash on Delivery</option>
                        <option value="Net Banking" id="card">Pay Online</option>
                    </select>
                </div>

                <div class="placeorder">
                    <button type="submit" class="btn" id="placeorder">Place Order</button>
                    <div id="paymentmessageContainer" class="btn-error" style="color:red"></div>
                    <button type="button" class="btn" id="razpybtn">Online Payment</button>
                 
                </div>
            </div>
        </div>
    </form>
    </div>

    <footer class="simple-footer">
        <div class="footer-container">
            <div class="footer-cta">
                <h2>Ready for a next project?</h2>
                <p>Let's get started!</p>
                <div class="footer-actions">
                    <a href="#" class="btn">Enter</a>
                    <a href="#" class="btn btn-outline">Continue</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>COLORLIB</h3>
                <ul>
                    <li><a href="#">Celebrate</a></li>
                    <li><a href="#">Buyer</a></li>
                    <li><a href="#">Supplier</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Charging</h3>
                <ul>
                    <li><a href="#">Abstract</a></li>
                    <li><a href="#">Content</a></li>
                    <li><a href="#">Comment</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Further Information</h3>
                <ul>
                    <li><a href="#">Terms & Conditions</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <div class="weather-widget">
                    <div class="temp">27°C</div>
                    <div class="condition">Partly cloudy</div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

 <script>
document.addEventListener('DOMContentLoaded', function () {
    // Mobile menu toggle functionality
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    const navLinks = document.querySelector('.nav-links');
    
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', function() {
            navLinks.classList.toggle('active');
        });
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.nav-container') && !event.target.closest('.nav-links')) {
            navLinks.classList.remove('active');
        }
    });

    const paymentSelect = document.getElementById('paymentmethod');
    const placeOrderBtn = document.getElementById('placeorder');
    const razorpayBtn = document.getElementById('razpybtn');
    const totalOrderPrice = parseFloat(document.getElementById('price').getAttribute('data-totalPrice'));
    const messageContainer = document.getElementById('messageContainer');
    const paymentmessageContainer = document.getElementById('paymentmessageContainer')

    // Hide Razorpay initially
    razorpayBtn.style.display = 'none';

    paymentSelect.addEventListener('change', function () {
        const paymentMethod = this.value;

        // Show alert if COD is selected and price > 1000
        if (paymentMethod === 'Cash on Delivery' && totalOrderPrice < 1000) {
            Swal.fire({
                icon: 'error',
                title: 'Order Limit Exceeded',
                text: 'Cash on delivery is not available for orders above Rs 1000'
            });
            this.value = '';
            razorpayBtn.style.display = 'none';
            placeOrderBtn.style.display = 'block';
            return;
        }

        // Toggle Razorpay and Place Order buttons
        if (paymentMethod === 'Net Banking') {
            razorpayBtn.style.display = 'block';
            placeOrderBtn.style.display = 'none';
        } else {
            razorpayBtn.style.display = 'none';
            placeOrderBtn.style.display = 'block';
        }
    });

    // Show error if Place Order is clicked without selecting payment method
    placeOrderBtn.addEventListener('click', function (e) {
        const paymentMethod = paymentSelect.value;

        if (!paymentMethod) {
            e.preventDefault(); // prevent form submission
           paymentmessageContainer.innerText = 'Please select a payment method before placing your order.';
           const addressError = document.getElementById('addressError');
           const selectedAddress = document.querySelector('input[name="shippingOption"]:checked');

             // Validate shipping address
        if (!selectedAddress) {
        e.preventDefault(); 
        addressError.innerText = 'Please add and select a shipping address before placing the order.';
        setTimeout(() => addressError.innerText = '', 3000);
         preventSubmission = true;
         }


            // Auto clear after 3 seconds
            setTimeout(() => {
               paymentmessageContainer.innerText = '';
            }, 3000);
        }
    });

    // Trigger once on page load
    paymentSelect.dispatchEvent(new Event('change'));
});

let alreadyUsedCoupon = false;
let overallTotalPrice = 0;

async function applyCoupon(totalPrice) {
    const messageContainer = document.getElementById('messageContainer');

    if (alreadyUsedCoupon) {
        messageContainer.textContent = 'Coupon already applied';
        return;
    }

    const coupencode = document.getElementsByName('coupencode')[0].value;

    try {
        console.log(`coupon code is ${coupencode}`);
        const response = await fetch('/coupencheck', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ coupencode: coupencode })
        });

        if (!response.ok) {
            messageContainer.textContent = 'please select a coupon';
            setTimeout(() => messageContainer.textContent = '', 2000);
            return;
        }

        const data = await response.json();

        if (data.success) {
            const discountValue = data.discount || 0;
            const amountLimit = data.amount || 0;
            overallTotalPrice = totalPrice - discountValue;

            if (totalPrice >= amountLimit) {
                messageContainer.textContent = 'Coupon code entered successfully';
                setTimeout(() => messageContainer.textContent = '', 2000);

                document.getElementById('discountvalue').textContent = discountValue.toFixed(2);
                document.getElementById('total-price2').textContent = `₹${overallTotalPrice.toFixed(2)}`;
                alreadyUsedCoupon = true;

                console.log(`Discount applied. New total: ₹${overallTotalPrice}`);
            } else {
                messageContainer.textContent = 'Purchase amount is not eligible for this coupon';
                setTimeout(() => messageContainer.textContent = '', 4000);
            }
        } else {
            messageContainer.textContent = 'Coupon code is either expired or invalid';
            setTimeout(() => messageContainer.textContent = '', 4000);
        }

    } catch (error) {
        messageContainer.textContent = 'Error applying coupon';
        console.log('Coupon error:', error);
    }
}

document.getElementById('applycoupen').addEventListener('click', function () {
    const totalPrice = parseFloat(document.getElementById('price').getAttribute('data-totalPrice'));
    applyCoupon(totalPrice);
});

function deleteCoupon() {
    fetch('/deleteCoupon', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        const messageContainer = document.getElementById('messageContainer');
        if (data.success) {
            alreadyUsedCoupon = false;
            const originalTotal = parseFloat(document.getElementById('price').getAttribute('data-totalPrice'));

            document.getElementById('discountvalue').innerText = '0.00';
            document.getElementById('total-price2').innerText = `₹${originalTotal.toFixed(2)}`;

            messageContainer.innerText = 'Coupon deleted successfully';

            delete window.sessionStorage.coupon;
            delete window.sessionStorage.coupencode;

            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            messageContainer.innerText = 'Failed to delete coupon';
            setTimeout(() => messageContainer.innerText = '', 3000);
        }
    })
    .catch(error => {
        console.log('Error deleting coupon:', error);
    });
}

document.getElementById('razpybtn').addEventListener('click', function(e) {
    e.preventDefault();

     const selectedAddress = document.querySelector('input[name="shippingOption"]:checked');
    const addressError = document.getElementById('addressError');

    if (!selectedAddress) {
        addressError.innerText = 'Please add and select a shipping address before placing the order.';
        setTimeout(() => addressError.innerText = '', 3000);
        return; // Stop Razorpay from proceeding
    }

    
    let price = document.getElementById('price');
    let orderPrice = price.getAttribute('data-totalPrice');
    console.log(`this is the order price ${orderPrice}`);
    console.log(`this is the discount price ${overallTotalPrice}`);

    $.ajax({
        url: '/create/orderId',
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            amount: (overallTotalPrice || orderPrice)
        }),
        success: function(response) {
            console.log('ok');
            const orderId = response.orderId;
            const orderPrice = response.orderPrice;
            const ordersignature = response.signature;

            const options = {
                key: "rzp_test_GaraATKzTHQjXo",
                amount: (overallTotalPrice || orderPrice) * 100,
                currency: 'INR',
                name: "AMLS",
                description: "Online Payment",
                order_id: orderId,
                handler: function (response) {
                    var form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/checkoutPost';

                    var paymentIdInput = document.createElement('input');
                    paymentIdInput.type = 'hidden';
                    paymentIdInput.name = 'razorpay_payment_id';
                    paymentIdInput.value = response.razorpay_payment_id;
                    form.appendChild(paymentIdInput);

                    var paymentModeInput = document.createElement('input');
                    paymentModeInput.type = 'hidden';
                    paymentModeInput.name = 'paymentMethod';
                    paymentModeInput.value = document.getElementById('paymentmethod').value;
                    form.appendChild(paymentModeInput);

                    var couponInput = document.createElement('input');
                    couponInput.type = 'hidden';
                    couponInput.name = 'coupencode';
                    couponInput.value = document.getElementById('coupencode').value;
                    form.appendChild(couponInput);

                    var selectedAddressInput = document.querySelector('input[name="shippingOption"]:checked');
                    if (selectedAddressInput) {
                        var addressIdInput = document.createElement('input');
                        addressIdInput.type = 'hidden';
                        addressIdInput.name = 'shippingOption';
                        addressIdInput.value = selectedAddressInput.value;
                        form.appendChild(addressIdInput);
                    }

                    document.body.appendChild(form);
                    form.submit();
                }
            };

            var rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response) {
                console.log('error data', response);
                console.log('got into error');
                window.location.href = '/paymentFailed';
            });

            rzp1.open();
        },
        error: function(error) {
            console.error('Error creating order:', error);
        }
    });
});

document.getElementById('logout-button').addEventListener('click', function (e) {
    e.preventDefault();

    Swal.fire({
        title: "Are you sure you want to logout?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, logout",
        cancelButtonText: "Cancel",
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "/logout";
        }
    });
});
</script>

<% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
    <script>
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: "<%= errorMessage %>",
            confirmButtonColor: '#f74f10'
        });
    </script>
<% } %>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</body>
</html>